<!DOCTYPE html>
<html>
<head>
    <title>Sign In</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="shortcut icon" href="logo.png" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="theme.js" defer></script>
</head>
<body class="narrow-view">
    <canvas id="bgParticles"></canvas>
    <script src="particles.js" defer></script>

<h2>Sign In</h2>

<input id="username" placeholder="Username">
<input id="password" placeholder="Password" type="password">
<button onclick="signin()">Sign In</button>

<div id="status">Waiting…</div>

<script>
        /* SUPABASE CLIENT (singleton) */
        if (!window.supabaseClient) {
            window.supabaseClient = window.supabase.createClient(
                "https://gftohejwfjstfhkfmyjd.supabase.co",
                "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdmdG9oZWp3ZmpzdGZoa2ZteWpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMjk0NjgsImV4cCI6MjA3ODcwNTQ2OH0.Zq7E-xAknaZBDkCN6IecWqsDc20vTVuNt54MBWNATdY"
            );
        }
        const client = window.supabaseClient;

    async function signin() {
        const status = document.getElementById("status");
        status.textContent = "Starting signin…";

        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value;

        if (!username || !password) {
            status.textContent = "❌ Missing username or password";
            return;
        }

        status.textContent = "Hashing password…";
        const password_hash = await sha256(password);

        status.textContent = "Checking account…";

        // Look up the user by username
        const { data: user, error } = await client
            .from("users")
            .select("*")
            .eq("username", username)
            .single();

        if (error) {
            status.textContent = "❌ No account with that username.";
            return;
        }

        // Check password match
        if (user.password_hash !== password_hash) {
            status.textContent = "❌ Incorrect password.";
            return;
        }

        // Save session locally
        localStorage.setItem("user_id", user.id);
        localStorage.setItem("username", user.username);

        status.textContent = "✅ Sign in successful! Redirecting…";

        setTimeout(() => {
            window.location.href = "index.html";
        }, 1500);
    }

    async function sha256(msg) {
        const m = new TextEncoder().encode(msg);
        const h = await crypto.subtle.digest("SHA-256", m);
        return Array.from(new Uint8Array(h))
            .map(b => b.toString(16).padStart(2, "0"))
            .join("");
    }
</script>

</body>
</html>